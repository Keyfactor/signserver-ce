<?xml version="1.0" encoding="UTF-8"?>
<project name="signserver" default="default" basedir=".">

    <!-- Import property file containing version numbers and other constants -->
    <property file="src/compile.properties"/>

    <property environment="env" />

    <!-- Give user a chance to override without editing this file
       (and without typing -D each time it compiles it).
       First it checks your home directory for signserver_build.properties
       net it checks the properties file here. -->
    <property file="${user.home}/${app.name}_build.properties" />
    <property file="${app.name}_build.properties" />

 	<!-- default value, will not set value if it is set in ${app.name}_build.properties -->
    <property name="appserver.type" value="jboss"/>

    <!-- A little special something to handle backward compatibility with 
	       people using JBOSS_HOME. They can switch to APPSRV_HOME now, and both will work. 
	  -->        
	  <condition property="jboss.home" value="${env.JBOSS_HOME}" >
	      <equals arg1="${appserver.home}" arg2="${appserver.home}"/>
	  </condition>
	  <condition property="appserver.home" value="${env.APPSRV_HOME}" else="${jboss.home}">
	      <contains string="${jboss.home}" substring="JBOSS_HOME"/>
	  </condition>
          <property name="j2ee.server.home" value="${appserver.home}"/>
	
	<property name="ant.home" value="${env.ANT_HOME}"/>
	
	<import file="bin/${appserver.type}.xml" />

    <property name="signserver.configfile" value="/etc/signserver/signserver.conf" />
	
    <!-- set global properties for this build -->
	<property name="tmp" location="tmp" /><!-- -->
    <property name="bin" location="./bin" />
    <property name="build" value="${bin}/classes" />
    <property name="lib" location="lib" />
	<property name="preprocessed" value="${tmp}/preprocessed"/>

    <property name="src" value="./src" />
    <property name="src.java" value="${src}/java" />
    <property name="signservercommon.src.java" value="./modules/SignServer-Common/src" />
    <property name="signserverejb.src.java" value="./modules/SignServer-ejb/src/java" />
    <property name="signserverwar.src.java" value="./modules/SignServer-war/src/java" />
    <property name="signserveradmincli.src.java" value="./modules/SignServer-AdminCLI/src" />
    <property name="src.appserver" value="${preprocessed}/appserver/jboss" />
	<property name="src.external" location="${tmp}/external"/>
    <property name="resources.dir"  location="./src/resources"/>	
    <property name="signserverwar.web.pub" value="./modules/SignServer-war/web/pub" />
    <property name="signserverwar.web.healthcheck" value="./modules/SignServer-war/web/healthcheck" />
    
    <property name="server.java.target" value="1.6" />
    <property name="client.java.target" value="1.6" />
<!-- the ejbca.target could have any valid value. no SignServer code dependent of ejbca is used -->
    <property name="ejbca.target" value="3.9"/>

    <property name="test.dir" value="${bin}/junit" />
    <property name="test.src.dir" location="${src}/test" />
    <property name="server.dist.dir" value="dist-server" />
    <property name="client.dist.dir" value="dist-client" />
	<property name="pkg.dist.dir" location="dist-pkg" />
    <property name="apidoc" value="./doc/api" />  
	
	<property name="custom.commandfactory" value="org.signserver.cli.DefaultSignServerCommandFactory"/>

	<import file="./signserver.xmli" />
	<import file="./mailsigner.xmli" />
	<import file="${custom.build.xml}" optional="true"/>
        
	<property name="signserver.cli.jar" value="dist-client/signserver-cli.jar" />
	<property name="build.mode" value="SIGNSERVER" />
	<condition property="buildMailSigner">		
		  <equals arg1="${build.mode}" arg2="MAILSIGNER" casesensitive="false" trim="true"/>		
	</condition>

    <property name="base" location="."/>

    <!-- Properties with paths to all module projects -->
    <!-- TODO: This should be loaded inside a target! -->
    <property file="modules/modules-project.properties"/>

    <!-- =================================================================== -->
    <!-- Build ALL                                                           -->
    <!-- =================================================================== -->

        <target name="default" depends="build" description="Default target"/>

	<target name="build" depends="signserver, mailsigner, signserver-cli,
            validationClient, signingAndValidationAPI">
		<antcall target="showtime"/>
	</target>
	


    <!-- =================================================================== -->
    <!-- Create the time stamp and build directory -->
    <!-- =================================================================== -->
    <target name="init" depends="j2ee:check">
        <echo>
------------- SYSTEM PROPERTIES --------------
ANT version                         = ${ant.version}
JRE version                         = ${java.version}
JRE vendor                          = ${java.vendor}
Java home                           = ${java.home}
Java extensions dir                 = ${java.ext.dirs}
OS name                             = ${os.name}
OS architecture                     = ${os.arch}
OS version                          = ${os.version}
        </echo>
    	<antcall target="signserver.init"/>
    	<antcall target="mailsigner.init"/>

        <!-- Create the time stamp -->
        <tstamp/>
        <!-- Create the build directory structure used by compile -->
        <mkdir dir="${build}"/>
        <mkdir dir="${server.dist.dir}/lib"/>
        <mkdir dir="${client.dist.dir}/lib"/>
    </target>
	
	<target name="ant:configure">
        <fail message="Please set the environment variable 'ANT_HOME' before running this task." unless="ant.home"/>
        <available file="${ant.home}/lib" property="ant.home.valid"/>
        <fail message="'ant.home' (${ant.home}) does not seem to be a valid ant home directory" unless="ant.home.valid"/>
		<copy todir="${ant.home}/lib">
		   <fileset dir="lib/ext">
			 <include name="junit-3.8.1.jar"/>
			 <include name="jsch-0.1.32.jar"/>
		   </fileset>
		</copy>
	</target>

    <!-- =================================================================== -->
    <!-- Main Clean                                                            -->
    <!-- =================================================================== -->
    <target name="clean" depends="signserver:clean, mailsigner:clean">
        <!-- Delete the ${build} and ${server.dist.dir} directory trees -->
        <delete dir="${build}" />
        <delete dir="${server.dist.dir}" />
    	<delete dir="${pkg.dist.dir}" />
        <delete dir="${apidoc}" />
        <delete dir="${tmp}"/>	
    	<delete dir="${client.dist.dir}" />
        <delete file="velocity.log" />
        <delete dir="${test.dir}" />
        <delete dir="${validationClientBuild}" />
        <delete dir="${signingAndValidationBuild}" />
        <delete dir="${wsraadminClientBuild}" />
        <delete dir="${timeStampClientBuild}" />
        <!-- AdminWS -->
        <ant antfile="${adminws.dir}/build.xml" target="clean"
            inheritall="false"/>
        <!-- AdminGUI -->
        <ant antfile="${admingui.dir}/build.xml" target="clean"
            inheritall="false"/>
    </target>
	

 
 
	<!--
	  Preprocesses Sign Server by replacing tags with correct version and application texts.
	-->
	<target name="preprocess" depends="preprocess-extjava, preprocess-extweb" >

        <!-- Copy xml-files and replace some values -->
        <copy todir="${preprocessed}">
            <fileset dir="src">
                <include name="**/*.xml"/>
            </fileset>
            <fileset dir="./modules/SignServer-war">
                <include name="*web/**/*.xml"/>
                <include name="*web/**/*.xml"/>
            </fileset>

			<filterchain>
			<tokenfilter>			    
				<replacestring from="@datasource.jndi-name-prefix@" to="${datasource.jndi-name-prefix}"/>
				<replacestring from="@datasource.jndi-name@" to="${datasource.jndi-name}"/>
				<replacestring from="@healthcheck.authorizedips@" to="${healthcheck.authorizedips}"/>
				<replacestring from="@healthcheck.minimumfreememory@" to="${healthcheck.minimumfreememory}"/>
				<replacestring from="@healthcheck.checkdbstring@" to="${healthcheck.checkdbstring}"/>
			</tokenfilter>
			</filterchain>
        </copy>

        <mkdir dir="${build}/org/signserver/common"/>

            <propertyfile file="${build}/org/signserver/common/signservercompile.properties" comment="SignServer compile-time properties. Generated file do not edit manually!">
                <entry key="appname" value="${app.name}"/>
                <entry key="appname_capital" value="${app.name.cap}"/>
                <entry key="rmiregistryport" value="${rmi.registry.port}"/>
                <entry key="rmiserverport" value="${rmi.server.port}"/>
                <entry key="mailsignerport" value="${mailsigner.smtpport}"/>
                <entry key="buildmode" value="${build.mode}"/>
                <entry key="datasource.jndi-name-prefix" value="${datasource.jndi-name-prefix}"/>
                <entry key="datasource.jndi-name" value="${datasource.jndi-name}"/>
                <entry key="healthcheck.authorizedips" value="${healthcheck.authorizedips}"/>
                <entry key="healthcheck.minimumfreememory" value="${healthcheck.minimumfreememory}"/>
                <entry key="healthcheck.checkdbstring" value="${healthcheck.checkdbstring}"/>
                <entry key="signserver.useclusterclassloader" value="${useclusterclassloader}"/>
                <entry key="signserver.useclassversions" value="${clusterclassloader.useclassversions}"/>
                <entry key="signserver.requiresignature" value="${clusterclassloader.requiresignature}"/>
                <entry key="signserver.pathtotruststore" value="${clusterclassloader.pathtotruststore}"/>
                <entry key="signserver.truststorepwd" value="${clusterclassloader.truststorepwd}"/>
                <entry key="SignServerCommandFactory" value="${custom.commandfactory}"/>
                <entry key="signserver.configfile" value="${signserver.configfile}"/>
                <entry key="signserver.version" value="${app.version}"/>
            </propertyfile>


		<!-- Make a copy of the signserver_cli.properties in bin dir -->
		<copy file="signserver_cli.properties" todir="bin" />
		<!-- Copy the correct jndi.properties for your appserver -->
		<copy file="bin/jndi.properties.${appserver.type}" tofile="bin/jndi.properties" overwrite="false" failonerror="false"/>
		<copy file="bin/jndi.properties.${appserver.type}" tofile="${src.java}/jndi.properties" overwrite="false" failonerror="false"/>

                <echo message="Database type:      ${database.name}"/>
                <echo message="DataSource mapping: ${datasource.jndi-name-prefix}${datasource.jndi-name}"/>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.DB2Dialect"><equals arg1="${database.name}" arg2="db2"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.DerbyDialect"><equals arg1="${database.name}" arg2="derby"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.HSQLDialect"><equals arg1="${database.name}" arg2="hsqldb"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.InformixDialect"><equals arg1="${database.name}" arg2="informix"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.IngresDialect"><equals arg1="${database.name}" arg2="ingres"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.SQLServerDialect"><equals arg1="${database.name}" arg2="mssql"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.MySQLDialect"><equals arg1="${database.name}" arg2="mysql"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.Oracle10gDialect"><equals arg1="${database.name}" arg2="oracle"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.PostgreSQLDialect"><equals arg1="${database.name}" arg2="postgres"/></condition>
                <condition property="hibernate.dialect" value="org.hibernate.dialect.SybaseDialect"><equals arg1="${database.name}" arg2="sybase"/></condition>
                <fail unless="hibernate.dialect" message="Unsupported database type '${database.name}'."/>
                <mkdir dir="${build}/META-INF"/>
                <copy file="${preprocessed}/appserver/${appserver.type}/persistence.xml" tofile="${build}/META-INF/persistence.xml" failonerror="true" overwrite="true">
                        <filterchain>
                            <expandproperties/>
                        </filterchain>
                </copy>
	</target>

	<target name="preprocess-extjava"  if="custom.src.java">
	    <mkdir dir="${preprocessed}/java"/>
        <copy todir="${preprocessed}/java">
            <fileset dir="${custom.src.java}">
              <include name="**"/>
            </fileset>	      
	    </copy>
	</target>
	
    <target name="preprocess-extweb"  if="custom.src.web">
       <mkdir dir="${preprocessed}/web/pub"/>       	
       <copy todir="${preprocessed}/web/pub">
          <fileset dir="${custom.src.web}">
             <include name="**"/>
           </fileset>	      
       </copy>
     </target>

     <!-- SignServer-Common -->
     <target name="signserver-common" depends="preprocess">
        <ant inheritall="false" target="jar"
            antfile="${signservercommon.dir}/build.xml"/>
        <mkdir dir="dist-client/lib" />
        <copy todir="dist-client/lib">
            <fileset dir="${signservercommon.dir}/dist">
                <include name="*.jar"/>
            </fileset>
        </copy>
        <mkdir dir="dist-server/lib" />
        <copy todir="dist-server/lib">
            <fileset dir="${signservercommon.dir}/dist">
                <include name="*.jar"/>
            </fileset>
        </copy>
     </target>

     <!-- SignServer-ejb -->
     <target name="signserver-ejb">
        <ant inheritall="false" target="dist"
            antfile="${signserverejb.dir}/build.xml"/>
        <mkdir dir="dist-client/lib" />
        <copy todir="dist-client/lib">
            <fileset dir="${signserverejb.dir}/dist">
                <include name="*.jar"/>
            </fileset>
        </copy>
     </target>

    <!-- AdminCLI -->
    <target name="signserver-cli" depends="signserver-common, signserver-ejb"
        description="Build SignServer AdminCLI">
        <ant inheritall="false" target="jar"
            antfile="${admincli.dir}/build.xml"/>

        <mkdir dir="dist-client/lib" />
        <copy todir="dist-client">
            <fileset dir="${admincli.dir}/dist">
                <include name="*.jar"/>
            </fileset>
        </copy>
    	
    	<echo message="Ignore warnings about jar files that can not be copied, they are for other application servers"/>
    	<!-- JBoss:
            For JBoss 4.2.3.GA only jbossall-client.jar is needed.
            For JBoss 5.1.0.GA jbossall-client.jar is referencing the needed
            libraries so all of them needs to be copied.
            <copy file="${appserver.home}/client/jbossall-client.jar" todir="${client.dist.dir}/lib" failonerror="false"/>
        -->
        <copy todir="${client.dist.dir}/lib" failonerror="false">
          <fileset dir="${appserver.home}/client">
             <include name="*.jar"/>
           </fileset>
       </copy>
    	<!-- Glassfish -->
    	<copy file="${appserver.home}/lib/appserv-rt.jar" todir="${client.dist.dir}/lib" failonerror="false"/> 
    	<copy file="${appserver.home}/lib/appserv-deployment-client.jar" todir="${client.dist.dir}/lib" failonerror="false"/> 
    	<copy file="${appserver.home}/lib/appserv-ext.jar" todir="${client.dist.dir}/lib" failonerror="false"/> 
    </target>


    <!-- =================================================================== -->
    <!-- Build modules -->
    <!-- =================================================================== -->

    <target name="modules" description="Build all enabled modules" depends="
             -module-pdfsigner-jar, -pdfsigner-jar-included, -pdfsigner-jar-excluded
            ,-module-cmssigner-jar, -cmssigner-jar-included, -cmssigner-jar-excluded
            ,-module-tsa-jar, -tsa-jar-included, -tsa-jar-excluded
            ,-module-odfsigner-jar, -odfsigner-jar-included, -odfsigner-jar-excluded
        "/>

    <target name="admingui" depends="signserver"
        description="Build the administration GUI">
        <ant antfile="${admingui.dir}/build.xml" target="jar"
            inheritall="false"/>
    </target>

    <!-- Target that can be called to build the renewal module -->
    <target name="module-renewal"
        description="Build the module Renewal">
        <ant antfile="${renewal.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${renewal.mar}" todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-renewal-jar" depends="module-renewal"
        if="module.renewal.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-renewal-jar-included" if="module.renewal.include.condition"
        depends="module-renewal">
        <echo message="Including Renewal module in EAR"/>
        <copy file="${renewal.jar}" todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-renewal-jar-excluded" 
        unless="module.renewal.include.condition">
        <echo message="Not including Renewal module in EAR"/>
    </target>

    <!-- Target that can be called to build the XMLSigner module -->
    <target name="module-xmlsigner"
        description="Build the module XMLSigner">
        <ant antfile="${xmlsigner.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${xmlsigner.mar}" todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-xmlsigner-jar" depends="module-xmlsigner"
        if="module.xmlsigner.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-xmlsigner-jar-included" if="module.xmlsigner.include.condition"
        depends="module-xmlsigner">
        <echo message="Including XMLSigner module in EAR"/>
        <copy file="${xmlsigner.jar}" todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-xmlsigner-jar-excluded"
        unless="module.xmlsigner.include.condition">
        <echo message="Not including XMLSigner module in EAR"/>
    </target>

    <!-- Target that can be called to build the PDFSigner module -->
    <target name="module-pdfsigner"
        description="Build the module PDFSigner">
        <ant antfile="${module.pdfsigner.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${module.pdfsigner.dir}/dist/pdfsigner.mar"
            todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-pdfsigner-jar" depends="module-pdfsigner"
        if="module.pdfsigner.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-pdfsigner-jar-included" if="module.pdfsigner.include.condition"
        depends="module-pdfsigner">
        <echo message="Including PDFSigner module in EAR"/>
        <copy file="${module.pdfsigner.dir}/dist/SignServer-Module-PDFSigner.jar"
            todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-pdfsigner-jar-excluded"
        unless="module.pdfsigner.include.condition">
        <echo message="Not including PDFSigner module in EAR"/>
    </target>

    <!-- Target that can be called to build the ODFSigner module -->
    <target name="module-odfsigner"
        description="Build the module ODFSigner">
        <ant antfile="${module.odfsigner.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${module.odfsigner.dir}/dist/odfsigner.mar"
            todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-odfsigner-jar" depends="module-odfsigner"
        if="module.odfsigner.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-odfsigner-jar-included" if="module.odfsigner.include.condition"
        depends="module-odfsigner">
        <echo message="Including ODFSigner module in EAR"/>
        <copy file="${module.odfsigner.dir}/dist/SignServer-Module-ODFSigner.jar"
            todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-odfsigner-jar-excluded"
        unless="module.odfsigner.include.condition">
        <echo message="Not including ODFSigner module in EAR"/>
    </target>

    <!-- Target that can be called to build the TSA module -->
    <target name="module-tsa"
        description="Build the module TSA">
        <ant antfile="${module.tsa.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${module.tsa.dir}/dist/tsa.mar"
            todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-tsa-jar" depends="module-tsa"
        if="module.tsa.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-tsa-jar-included" if="module.tsa.include.condition"
        depends="module-tsa">
        <echo message="Including TSA module in EAR"/>
        <copy file="${module.tsa.dir}/dist/SignServer-Module-TSA.jar"
            todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-tsa-jar-excluded"
        unless="module.tsa.include.condition">
        <echo message="Not including TSA module in EAR"/>
    </target>

    <!-- Target that can be called to build the CMSSigner module -->
    <target name="module-cmssigner"
        description="Build the module CMSSigner">
        <ant antfile="${module.cmssigner.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${module.cmssigner.dir}/dist/cmssigner.mar"
            todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-cmssigner-jar" depends="module-cmssigner"
        if="module.cmssigner.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-cmssigner-jar-included" if="module.cmssigner.include.condition"
        depends="module-cmssigner">
        <echo message="Including CMSSigner module in EAR"/>
        <copy file="${module.cmssigner.dir}/dist/SignServer-Module-CMSSigner.jar"
            todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-cmssigner-jar-excluded"
        unless="module.cmssigner.include.condition">
        <echo message="Not including CMSSigner module in EAR"/>
    </target>

    <!-- Target that can be called to build the WSRA module -->
    <target name="module-wsra"
        description="Build the module WSRA (and DummyWS)">
        <ant antfile="${wsra.dir}/build.xml" target="jar"
            inheritall="false"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-wsra-jar" depends="module-wsra"
        if="module.wsra.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-wsra-jar-included" if="module.wsra.include.condition"
        depends="module-wsra">
        <echo message="Including WSRA and DummyWS modules in EAR"/>
        <copy file="${wsra.dir}/dist/wsra-module.jar" todir="${server.dist.dir}/lib"/>
        <copy file="${wsra.dir}/dist/genericws-module-common.jar" todir="${server.dist.dir}/lib"/>
        <copy file="${wsra.dir}/dist/dummyws-module.jar" todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-wsra-jar-excluded"
        unless="module.wsra.include.condition">
        <echo message="Not including WSRA module in EAR"/>
    </target>

    <!-- Target that can be called to build the XMLSigner module -->
    <target name="module-mrtdsodsigner"
        description="Build the module MRTDSODSigner">
        <ant antfile="${module.mrtdsodsigner.dir}/build.xml" target="jar"
            inheritall="false"/>
        <copy file="${module.mrtdsodsigner.dir}/dist/mrtdsodsigner.mar"
            todir="${server.dist.dir}"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-mrtdsodsigner-jar" depends="module-mrtdsodsigner"
        if="module.mrtdsodsigner.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-mrtdsodsigner-jar-included"
            if="module.mrtdsodsigner.include.condition"
            depends="module-mrtdsodsigner">
        <echo message="Including MRTDSODSigner module in EAR"/>
        <copy file="${module.mrtdsodsigner.dir}/dist/SignServer-Module-MRTDSODSigner.jar"
            todir="${server.dist.dir}/lib"/>
    </target>
    <target name="-mrtdsodsigner-jar-excluded"
        unless="module.mrtdsodsigner.include.condition">
        <echo message="Not including MRTDSODSigner module in EAR"/>
    </target>

    <!-- Target that can be called to build the Log4j module -->
    <target name="module-log4j"
        description="Build the module Log4j">
        <ant antfile="${module.log4j.dir}/build.xml" target="jar"
            inheritall="false"/>
    </target>
    <!-- Target always called when building. Only builds if configured. -->
    <target name="-module-log4j-jar" depends="module-log4j"
        if="module.log4j.enabled.condition"/>
    <!-- Target for including the module -->
    <target name="-log4j-jar-included"
            if="module.log4j.include.condition"
            depends="module-log4j">
        <echo message="Including Log4j configuration in EAR"/>
        <copy file="${module.log4j.dir}/dist/SignServer-Module-Log4j.jar"
            todir="${server.dist.dir}/lib"/>
    </target>

 
	   <!-- =================================================================== -->
	    <!-- Build preparation for package distribution                         -->
	    <!-- =================================================================== -->
    	    <target name="pkgdist" depends="signserver, mailsigner, signserver-cli, signserver-pkgdist, mailsigner-pkgdist">

    	    </target>
    		
    <!-- =================================================================== -->
    <!-- Build Javadoc part                                                  -->
    <!-- =================================================================== -->
    <target name="javadoc" depends="build">
        <mkdir dir="${apidoc}" />
        <javadoc packagenames="org.signserver.*" maxmemory="256m" sourcepath="${src.java}" destdir="${apidoc}"
        	extdirs="${lib}:${lib}/ext:${ant.home}/lib:${lib}/ext/ejb:${lib}/ext/james:${lib}/asm:${lib}/${server.java.target}/:${lib}/${client.java.target}/:${lib}/module/tsa/${server.java.target}:${lib}/module/pdfsigner/itext:${lib}/module/wsra:${lib}/reports:${lib}/quartz:${lib}/jaxws:${lib}/module/odfsigner/odfdom.jar"
        	classpath="${server.compile.classpath}:${tmp}/jaxws/gen-classes/client:${lib}/module/odfsigner/odfdom.jar:${lib}/module/ooxmlsigner/openxml4j_beta_v538.jar"
        	author="true" version="true" use="true" windowtitle="${app.name.cap} API" bottom="Copyright &#169; 2005-2010 PrimeKey Solutions AB.">
                <fileset dir="${src.java}">
                    <include name="**/*.java"/>
                </fileset>
                <fileset dir="${signservercommon.src.java}">
                    <include name="**/*.java"/>
                </fileset>
                <fileset dir="${signserverejb.src.java}">
                    <include name="**/*.java"/>
                </fileset>
        </javadoc>
    </target>
		
    <macrodef name="keytool">
       <attribute name="arg"/>
         <sequential>
         <exec executable="keytool">
            <arg line="@{arg}"/>
         </exec>
         </sequential>
    </macrodef>

    <!--
        this macro is a specialized copy for deployment descriptors (dd).
        In the wonderful world of J2EE nothing it is always painful
        Basically it is copying the appropriate DD for each J2EE server
        and selected database:
        @database.name
    -->
    <macrodef name="ejb-merge-copy">
        <attribute name="database" />
        <attribute name="overwrite" default="false" />
        <sequential>
            <!-- Remove old possible files -->
        	<delete dir="${ejbdd.src}/merge/se"/>
            <!-- jboss configuration -->
            <copy todir="${ejbdd.src}/merge" overwrite="@{overwrite}" failonerror="false">
                <fileset dir="${ejbdd.src}/merge/${database.name}" includes="**/*.xml" />
            </copy>
        </sequential>
    </macrodef>

	<!--
        this macro is a specialized copy for deployment descriptors (dd).
        In the wonderful world of J2EE nothing it is always painful
    -->
    <macrodef name="ejb-dd-copy">
        <attribute name="todir" />
        <attribute name="dir" />
        <attribute name="overwrite" default="false" />
        <sequential>
        </sequential>
    </macrodef>

    <target name="test:compile"  depends="test:mailsigner:compile"/>
 	
    <target name="test:run" description="Run the default JUnit testcases">
        <antcall target="test:signserver:run"/>
    	<antcall target="test:mailsigner:run"/>
    </target>

    <target name="test:runall" description="Run all JUnit testcases">
        <antcall target="test:signserver:runall"/>
    	<antcall target="test:mailsigner:runall"/>
    </target>

    <target name="test:runperf" description="Test performace of signing modules">
        <antcall target="test:signserver:performance"/>
    </target>
		
	<property name="velocity.dir" location="lib/ext/velocity"/>
    <!-- Initialization properties -->
    <property name="project.name" value="signserver"/>
    <property name="docs.src"     location="doc/xdocs"/>
    <property name="docs.dest"    location="tmp/htdocs"/>
    <property name="docs.singlepages"    location="tmp/singledocs"/>
    <property name="project.file" value="stylesheets/project.xml" />
    <property name="templ.path"   location="${docs.src}/stylesheets" />
    <property name="velocity.props"   location="${docs.src}/velocity.properties" />
    <property name="include.xml"  value="**/*.xml" />
    <property name="docs.fullmanual" location="${docs.src}/manual/complete.en.xml"/>

    <target name="prepare">
        <path id="anakia.classpath">
            <fileset dir="${velocity.dir}">
                <include name="*.jar"/>
            </fileset>
        </path>
        <available classname="org.apache.velocity.anakia.AnakiaTask"
                   property="AnakiaTask.present">
            <classpath refid="anakia.classpath"/>
        </available>
        <path id="xmltask.classpath">
            <fileset dir="lib/ext/">
                <include name="xmltask.jar"/>
            </fileset>
        </path>
        <available classname="com.oopsconsultancy.xmltask.ant.XmlTask"
                   property="XmlTask.present">
            <classpath refid="xmltask.classpath"/>
        </available>
    </target>

    <target depends="prepare" name="prepare-error" unless="AnakiaTask.present">
        <echo>
            AnakiaTask is not present! Please check to make sure that
            velocity.jar is in your classpath.
        </echo>
        <mkdir dir="${docs.dest}"/>
    </target>

    <target name="doc:splitmanual" depends="prepare-error">

        <mkdir dir="${docs.singlepages}/manual"/>
        <copy todir="${docs.singlepages}/stylesheets">
            <fileset dir="${templ.path}"/>
        </copy>

        <!-- Split full.xml into xml-files for each chapter -->
        <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask">
            <classpath refid="xmltask.classpath"/>
        </taskdef>

        <!-- call subtargets using the full manual as the driver -->
        <xmltask source="${docs.fullmanual}">
          <call path="/document/body/chapter" target="doc:splitmanual:singlepage" buffer="chapter_buffer" inheritAll="true">
            <param name="1" path="@name"/>
            <param name="2" path="@shortname"/>
            <param name="3" value="${os.name}"/>
            <param name="4" path="node()"/>
          </call>
        </xmltask>
    </target>

    <target name="doc:splitmanual:singlepage">
        <xmltask dest="${docs.singlepages}/manual/${2}.xml">
          <insert path="/">
            <![CDATA[
              <document>
                <properties>
                    <title/>
                    <singlepage value="true"/>
                </properties>
                <body/>
              </document>
            ]]>
          </insert>
          <insert path="/document/properties/title">${1}</insert>
          <insert path="/document/body" buffer="chapter_buffer" position="under"/>
        </xmltask>
    </target>

    <target name="doc" if="AnakiaTask.present" depends="prepare-error, doc:splitmanual" description="Build SignServer web site and docs">
        <taskdef name="anakia" classname="org.apache.velocity.anakia.AnakiaTask">
            <classpath refid="anakia.classpath"/>
        </taskdef>

        <!-- Use FOP for creating PDF-files -->
        <!--<property name="fop.home" value="lib/ext/fop/"/>
        <taskdef name="fop" classname="org.apache.fop.tools.anttasks.Fop">
	  <classpath>
	    <fileset dir="${fop.home}/lib">
	      <include name="*.jar"/>
	    </fileset>
	    <fileset dir="${fop.home}/build">
	      <include name="fop.jar"/>
	      <include name="fop-hyph.jar" />
	    </fileset>
	  </classpath>
	</taskdef>-->

        <!--<echo message="docs.src: ${docs.src}"/>
        <echo message="docs.dest: ${docs.dest}"/>
        <echo message="project.file: ${project.file}"/>
        <echo message="include.xml: ${include.xml}"/>
        <echo message="templ.path: ${templ.path}"/>
        <echo message="velocity.props: ${velocity.props}"/>-->

        <anakia basedir="${docs.src}" destdir="${docs.dest}"
             extension=".html" style="./site.vsl"
             projectFile="${project.file}"
             excludes="**/stylesheets/**"
             includes="${include.xml}"
             lastModifiedCheck="true"
             templatePath="${templ.path}"
             velocityPropertiesFile="${velocity.props}">
        </anakia>

        <!-- Also for manual singlepages -->
        <anakia basedir="${docs.singlepages}" destdir="${docs.dest}"
             extension=".html" style="./site.vsl"
             projectFile="${project.file}"
             excludes="**/stylesheets/**"
             includes="${include.xml}"
             lastModifiedCheck="true"
             templatePath="${templ.path}"
             velocityPropertiesFile="${velocity.props}">
        </anakia>
        
        <copy todir="${docs.dest}">
        	<fileset dir="${docs.src}" includes="**/*.css,**/*.png,**/*.jpg,**/*.gif"/>        	
        	<fileset dir="${docs.src}" includes="docs/**/*"/>
        </copy>
    	<echo message=""/>
    	<echo message="Local documentation is now available in file://${docs.dest}/index.html"/>
    </target>
    
    <target name="site:test:publish" depends="doc" description="Publish the website to the sandbox subdirectory.">
    	<property name="publish.dir" value="/home/groups/s/si/signserver/htdocs/sandbox"/>
        <property name="publish.host" value="shell.sourceforge.net"/>

        <echo message="Publish to ${publish.host}:${publish.dir}"/>
        <input message="Please enter username: " addproperty="username"/>
        <input message="Please enter password: " addproperty="password"/>
    	<tar destfile="htdocs.tgz" compression="gzip">
    		<tarfileset dir="${docs.dest}" mode="664" dirmode="775" username="${username}" group="ejbca"/>
    	</tar>
    	<scp trust="true" file="htdocs.tgz" todir="${username}:${password}@${publish.host}:"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="mkdir ${publish.dir} ; tar -xzpf htdocs.tgz -C ${publish.dir};"/>
		<!-- I'm setting the permissions this way as there seems to be a problem with dirmode -->
		<echo message="Setting directory permissions"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="find ${publish.dir} -type d -exec chmod 775 {} \;"/> 
		<echo message="Setting file permissions"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="find ${publish.dir} -type f -exec chmod 664 {} \;"/>
    	<delete file="htdocs.tgz"/>
    </target>
    <target name="site:publish" depends="doc" description="Publish the website to the sandbox subdirectory.">
        <property name="publish.dir" value="/home/groups/s/si/signserver/htdocs"/>
        <property name="publish.host" value="shell.sourceforge.net"/>

        <echo message="Publish to ${publish.host}:${publish.dir}"/>
        <input message="Please enter username: " addproperty="username"/>
        <input message="Please enter password: " addproperty="password"/>
    	<tar destfile="htdocs.tgz" compression="gzip">
    		<tarfileset dir="${docs.dest}" mode="664" dirmode="775" username="${username}" group="ejbca"/>
    	</tar>
    	<scp trust="true" file="htdocs.tgz" todir="${username}:${password}@${publish.host}:"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="mkdir ${publish.dir} ; tar -xzpf htdocs.tgz -C ${publish.dir};"/>
		<!-- I'm setting the permissions this way as there seems to be a problem with dirmode -->
		<echo message="Setting directory permissions"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="find ${publish.dir} -type d -exec chmod 775 {} \;"/> 
		<echo message="Setting file permissions"/>
    	<sshexec trust="true" host="${publish.host}"
				username="${username}" password="${password}"
				command="find ${publish.dir} -type f -exec chmod 664 {} \;"/>
    	<delete file="htdocs.tgz"/>
    </target>

	<!-- A small script that converts the version x.y.z to x_y_z to be used in the file -->
	<scriptdef name="convertdot" language="javascript">
	    <![CDATA[
          ver = project.getProperty("app.version.number");
		  relstring = ver.replace('.','_');
	      //self.log(ver);
	      //self.log(relstring);
		  project.setProperty("signserver.zipversion", relstring);
          str = project.getProperty("signserver.zipversion");
	    ]]>
    	</scriptdef>
	
        <!-- Deprecated: New target called release:zip -->
        <target name="ziprelease">
            <antcall target="release:zip" />
        </target>

    	<target name="release:zip" description="Make a zip file for SignServer release" >
    		<convertdot/> <!-- convert dots to underscores in version string -->
    		<!-- <input message="Version tag for zipfile (ex 3_1_0):" addproperty="signserver.zipversion" /> -->    		
    		<antcall target="-release:zip-lgpl21"/>
    	</target>

    	<target name="release:source-zip" description="Make a source zip files for SignServer release" >
    		<convertdot/> <!-- convert dots to underscores in version string -->
    		<!-- <input message="Version tag for zipfile (ex 3_1_0):" addproperty="signserver.zipversion" /> -->
    		<antcall target="-release:source-zip-lgpl21"/>
    	</target>

        <target name="release:source-tarball" description="Make a source tarball for SignServer release">
            <convertdot/>
            <antcall target="-release:source-tarball-lgpl21"/>
        </target>
    		
	<target name="-release:zip-lgpl21" >
		<antcall  target="clean"/>  
		<copy file="doc/lgpl-2.1.txt" tofile="LICENSE" />
		<zip destfile="../signserver_lgpl_v21_version_${signserver.zipversion}.zip">
		    <zipfileset dir="." prefix="signserver_lgpl_v21_version_${signserver.zipversion}" filemode="600" dirmode="700"> 
		    	<include name="**/**" />
		    	<exclude name="doc/lgpl-**" />
		    	<exclude name="**/CVS/**" />
			<exclude name="signserver_build.properties" />
		    	<exclude name="tmp/**" />
		    	<exclude name="p12/**" />
		    	<exclude name="dist/**" />
		    	<exclude name="dist-client/**" />
		    	<exclude name="dist-server/**" />
		    	<exclude name="out/**" />
		    	<exclude name="eclipseBuild/**" />
		    	<exclude name="**/*.class" />
		    	<exclude name=".classpath" />
		    	<exclude name=".project" />
		    	<exclude name=".eclipse/**" />
                        <exclude name=".settings/**" />
		    	<exclude name="**/.cvsignore" />
		    	<exclude name="**/*.sh" />
                        <exclude name="**/nbproject/private/**" />
		    </zipfileset>
		    <zipfileset dir="." prefix="signserver_lgpl_v21_version_${signserver.zipversion}" filemode="700" dirmode="700"> 
		    	<include name="**/*.sh" />
		    </zipfileset>
		</zip>
		<delete file="LICENSE"/>
        <checksum file="../signserver_lgpl_v21_version_${signserver.zipversion}.zip" algorithm="SHA1" forceOverwrite="yes"/>      
        <checksum file="../signserver_lgpl_v21_version_${signserver.zipversion}.zip" algorithm="SHA1" property="signserverSHA1"/>      
        <echo message="SHA1 checksum: ${signserverSHA1}" />
	</target>

    <target name="-release:source-zip-lgpl21" >
        <antcall  target="clean"/>
        <copy file="doc/lgpl-2.1.txt" tofile="LICENSE" />
        <zip destfile="../signserver_lgpl_v21_version_${signserver.zipversion}-src.zip">
            <zipfileset dir="." prefix="signserver_lgpl_v21_version_${signserver.zipversion}-src" filemode="600" dirmode="700">
                <include name="**/**" />
                <exclude name="doc/lgpl-**" />
                <exclude name="**/CVS/**" />
                <exclude name="signserver_build.properties" />
                <exclude name="tmp/**" />
                <exclude name="p12/**" />
                <exclude name="**/dist/**" />
                <exclude name="**/build/**" />
                <exclude name="extapps/**" />
                <exclude name="SignServer-AdminGUI/lib/**" />
                <exclude name="dist-client/**" />
                <exclude name="dist-server/**" />
                <exclude name="out/**" />
                <exclude name="eclipseBuild/**" />
                <exclude name="**/*.class" />
                <exclude name=".classpath" />
                <exclude name=".project" />
                <exclude name=".eclipse/**" />
                <exclude name=".settings/**" />
                <exclude name="**/.cvsignore" />
                <exclude name="**/*.sh" />
                <exclude name="**/nbproject/private/**" />
                <exclude name="**/lib/**" />
            </zipfileset>
            <zipfileset dir="." prefix="signserver_lgpl_v21_version_${signserver.zipversion}-src" filemode="700" dirmode="700">
                <include name="**/*.sh" />
            </zipfileset>
        </zip>
        <delete file="LICENSE"/>
        <checksum file="../signserver_lgpl_v21_version_${signserver.zipversion}-src.zip" algorithm="SHA1" forceOverwrite="yes"/>
        <checksum file="../signserver_lgpl_v21_version_${signserver.zipversion}-src.zip" algorithm="SHA1" property="signserverSHA1"/>
        <echo message="SHA1 checksum: ${signserverSHA1}" />
    </target>

    <target name="-release:source-tarball-lgpl21" >
        <antcall  target="clean"/>
        <copy file="doc/lgpl-2.1.txt" tofile="LICENSE" />
        <property name="tarball.tar" value="../signserver_lgpl_v21_version_${signserver.zipversion}-src.tar" />
        <property name="tarball.tar.gz" value="${tarball.tar}.gz" />
        <tar tarfile="${tarball.tar}" basedir=".." longfile="gnu">
                <include name="signserver/**" />
                <exclude name="signserver/doc/lgpl-**" />
                <exclude name="**/CVS/**" />
                <exclude name="signserver/signserver_build.properties" />
                <exclude name="signserver/tmp/**" />
                <exclude name="signserver/p12/**" />
                <exclude name="**/dist/**" />
                <exclude name="**/build/**" />
                <exclude name="signserver/extapps/**" />
                <exclude name="signserver/SignServer-AdminGUI/lib/**" />
                <exclude name="signserver/dist-client/**" />
                <exclude name="signserver/dist-server/**" />
                <exclude name="signserver/out/**" />
                <exclude name="signserver/eclipseBuild/**" />
                <exclude name="**/*.class" />
                <exclude name="signserver/.classpath" />
                <exclude name="signserver/.project" />
                <exclude name="signserver/.eclipse/**" />
                <exclude name="signserver/.settings/**" />
                <exclude name="**/.cvsignore" />
                <exclude name="**/*.sh" />
                <exclude name="**/nbproject/private/**" />
                <exclude name="**/lib/**" />
        </tar>
        <gzip destfile="${tarball.tar.gz}" src="${tarball.tar}"/>
        <delete file="${tarball.tar}"/>
        <delete file="LICENSE"/>
        <checksum file="${tarball.tar.gz}" algorithm="SHA1" forceOverwrite="yes"/>
        <checksum file="${tarball.tar.gz}" algorithm="SHA1" property="signserverSHA1"/>
        <echo message="SHA1 checksum: ${signserverSHA1}" />
    </target>

	<target name="showtime">
		<tstamp>
			<format property="completiontime" pattern="yyyy-MM-dd HH:mm:ss Z"/>
		</tstamp>
		<echo message="Task completed ${completiontime}."/>
	</target>	

</project>
