<project name="wsra" default="wsramar" basedir="..">

<property name="wsraadminClientBuild" value="${bin}/wsraadminClient"/>
<property name="wsraadminWSClientBuild" value="${tmp}/wsra/gen-classes/client"/>
<property name="wsraadminClientDir" value="${client.dist.dir}/wsraadminclient"/>
<property name="wsraadminClientJar" value="${wsraadminClientDir}/wsraadmin.jar"/>
<property name="wsraadminWSClientJar" value="${client.dist.dir}/wsraclient-lib.jar"/>
<import file="./dummyws.xml"/>       
<target name="wsramar" depends="dummywsmar" if="module.wsra.enabled.condition" unless="buildMailSigner">
    <path id="wsramar.build.classpath">
      <path refid="jaxws.classpath" />
      <path location="${build}" />      
    </path>

    <taskdef name="mar" classname="org.signserver.anttasks.MarAntTask" 
      classpathref="wsramar.build.classpath" />
       
    <taskdef name="part" classname="org.signserver.anttasks.PartAntTask" 
      classpathref="wsramar.build.classpath"/>
 
 
    <javac destdir="${build}" debug="on" includeantruntime="no" encoding="iso8859-1" target="${server.java.target}" source="${server.java.target}">
       <classpath refid="wsramar.build.classpath" />
       <src path="${src.java}" /> 
       <include name="org/signserver/module/wsra/*.java"/>
       <include name="org/signserver/module/wsra/**/*.java"/>        
    </javac>
    
  
    <taskdef name="wsgen" classname="com.sun.tools.ws.ant.WsGen" >
       <classpath refid="jaxws.classpath"/>                
    </taskdef>
        
    <taskdef name="wsimport" classname="com.sun.tools.ws.ant.WsImport">
       <classpath refid="jaxws.classpath"/>
    </taskdef>
                
    <mkdir dir="tmp/wsra/gen-classes/server"/>
    <mkdir dir="tmp/wsra/gen-classes/client"/>           

    <wsgen  fork="true" sei="org.signserver.module.wsra.ws.WSRA"
                 genwsdl="true" destdir="tmp/wsra/gen-classes/server"              
                debug="true" xendorsed="true">
              
      <classpath>
         <path refid="jaxws.classpath" /> 
         <pathelement location="src" /> 
      </classpath>
    </wsgen>
        
     <copy todir="tmp/wsra/gen-classes/server">
        <fileset dir="${build}">                
           <include name="org/signserver/module/wsra/*.class"/>
           <include name="org/signserver/module/wsra/**/*.class"/>  
        </fileset>
     </copy> 
     <copy file="src/module-configs/wsra/sun-jaxws.xml" tofile="tmp/wsra/gen-classes/server/sun-jaxws.xml"/>
        
     <wsimport destdir="${tmp}/wsra/gen-classes/client"
        wsdl="${tmp}/wsra/gen-classes/server/WSRAService.wsdl" >
     </wsimport>

	<jar jarfile="dist-server/wsra-module.jar">
		<fileset dir="tmp/wsra/gen-classes/server">
		    <include name="**"/>		    
		</fileset>
		<fileset dir="${build}">
            <include name="org/signserver/protocol/ws/Certificate.class"/>
            <include name="org/signserver/protocol/validationservice/ws/ValidationResponse.class"/>            
        </fileset>
    </jar>
    <mar version="${mar.versions}" modulename="wsra" verbose="true" destfile="${basedir}/dist-server/wsra.mar">
        <part>
            <fileset dir="dist-server">
                <include name="wsra-module.jar"/>
                <include name="genericws-module-common.jar"/>
            </fileset>
            <fileset dir="src/module-configs/wsra">
                <include name="*.properties"/>
            </fileset>
        </part>
    </mar>
    
    <mkdir dir="${wsraadminClientBuild}"/>
    <javac srcdir="${src.java}" destdir="${wsraadminClientBuild}" debug="on" target="${client.java.target}" source="${client.java.target}">
           <include name="org/signserver/client/wsraadmin/*.java"/>            
           <classpath refid="signserver.compile.classpath"/>
           <!-- TODO: Markus: The wsra admin client.jar file currently contains classes from
           the commons package and EJB.
           In the future it would be better it depends on the
           SignServer-Common.jar instead of doing a separe build of those
           classes. -->
           <sourcepath>
               <dirset dir="${src.java}" />
               <dirset dir="${signservercommon.src.java}" />
               <dirset dir="${signserverejb.src.java}" />
           </sourcepath>
    </javac>
    <mkdir dir="${wsraadminClientDir}/lib"/>
    <copy todir="${wsraadminClientDir}/lib" >
      <fileset dir="${lib}/${client.java.target}">
         <include name="bcprov-jdk.jar"/>            
         <include name="bcmail-jdk.jar"/>
      </fileset>
      <fileset dir="${lib}">        
         <include name="log4j.jar"/>      
         <include name="commons-lang-2.4.jar"/>
         <include name="commons-logging.jar"/>
         <include name="commons-collections-3.2.jar"/>
         <include name="ejbca-util.jar"/>
       </fileset>  
       <fileset dir="${lib}/ext">
          <include name="commons-cli-1.0.jar"/>
       </fileset>
       <fileset dir="${lib}/ext/ejb">
          <include name="ejb3-persistence.jar"/>
          <include name="hibernate3.jar"/>
          <include name="hibernate-annotations.jar"/>
          <include name="hibernate-entitymanager.jar"/>
          <include name="jboss-ejb3x.jar"/>
          <include name="jboss-j2ee.jar"/>                              
       </fileset>
       <fileset dir="${appserver.home}/server/default/lib">
          <include name="hsqldb.jar"/>
          <include name="dom4j.jar"/>
          <include name="cglib.jar"/>
          <include name="antlr.jar"/>                           
       </fileset>
       </copy>
       <copy todir="${wsraadminClientDir}" >
         <fileset dir="${build}">
           <include name="org/signserver/module/wsra/*.class"/>
           <include name="org/signserver/module/wsra/**/*.class"/> 
           <include name="org/signserver/protocol/ws/Certificate.class"/>
           <include name="org/signserver/protocol/validationservice/ws/ValidationResponse.class"/>            
         </fileset>       
       </copy>
       <copy todir="${wsraadminClientDir}" >
         <fileset dir="src/module-configs/wsra/cli">
          <include name="wsraadmin.properties"/>                           
         </fileset>
       </copy>
       <copy todir="${wsraadminClientBuild}" >
         <fileset dir="src/module-configs/wsra/cli">
          <include name="log4j.properties"/>                           
         </fileset>
       </copy>
         
       <jar destfile="${wsraadminClientJar}" basedir="${wsraadminClientBuild}">
          <manifest>
            <attribute name="Class-Path" value="lib/bcprov-jdk.jar lib/bcmail-jdk.jar lib/commons-cli-1.0.jar  lib/ejbca-util.jar lib/log4j.jar  lib/commons-lang-2.4.jar lib/ejb3-persistence.jar lib/hibernate3.jar lib/hibernate-annotations.jar lib/hibernate-entitymanager.jar lib/jboss-ejb3x.jar lib/jboss-j2ee.jar lib/hsqldb.jar lib/dom4j.jar lib/cglib.jar lib/antlr.jar lib/commons-collections-3.2.jar lib/commons-logging.jar"/>
            <attribute name="Main-Class" value="org.signserver.client.wsraadmin.WSRAAdminCLI"/>
          </manifest>
       </jar>
       <copy todir="${wsraadminWSClientBuild}" >
        <fileset dir="${build}">
          <include name="org/signserver/module/wsra/common/WSRAConstants*.class"/>
          <include name="org/signserver/module/wsra/common/Roles.class"/>
          <include name="org/signserver/module/wsra/common/tokenprofiles/*.class"/>
          <include name="org/signserver/common/*.class"/>
          <include name="org/signserver/module/wsra/common/authtypes/*.class"/>
          <include name="org/signserver/cli/mailsigner/vo/*.class"/>
        </fileset>       
       </copy>	
       <jar destfile="${wsraadminWSClientJar}" basedir="${wsraadminWSClientBuild}">
         <manifest> </manifest>
       </jar>
</target>

</project>
