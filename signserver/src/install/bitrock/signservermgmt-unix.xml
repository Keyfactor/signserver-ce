<project>
    <shortName>signservermgmt</shortName>
    <fullName>SignServer Management</fullName>
    <version>3.1</version>
    <readmeFile>../common/README.txt</readmeFile>
    <licenseFile>../../../doc/lgpl-2.1.txt</licenseFile>
    <!-- <registerWithPackageDatabase>1</registerWithPackageDatabase> -->
    <vendor>PrimeKey Solutions AB</vendor>
    <summary>CLI interface for managing a SignServer Cluster.</summary>
    <release>3.1</release>
    <description>CLI interface for managing a SignServer Cluster</description>
    <rebootRequired>0</rebootRequired>    
    <startMenuGroupName></startMenuGroupName>
    <preInstallationActionList>
        <setInstallerVariable>
                <name>installdir</name>
                <value>/opt/signserver-${product_version}</value>
                <ruleList>
                  <platformTest>                    
                    <type>linux</type>
                  </platformTest>                
                </ruleList>
        </setInstallerVariable>
        <setInstallerVariable>
                <name>uninstallerName</name>
                <value>uninstall-${product_shortname}</value>
                <ruleList>
                  <platformTest>                    
                    <type>linux</type>
                  </platformTest>                
                </ruleList>
        </setInstallerVariable>
        <autodetectJava>
            <promptUser>0</promptUser>
            <validVersionList>
                <validVersion>
                    <maxVersion></maxVersion>
                    <minVersion>1.5.0</minVersion>
                    <requireJDK>0</requireJDK>
                    <vendor>sun</vendor>
                </validVersion>
            </validVersionList>
        </autodetectJava>
        <addUser>
            <abortOnError>0</abortOnError>
            <showMessageOnError>0</showMessageOnError>
            <username>signserver</username>
        </addUser>
        <addGroup>
            <abortOnError>0</abortOnError>
            <groupname>signserver</groupname>
            <showMessageOnError>0</showMessageOnError>
        </addGroup>
        <addGroupToUser>
            <groupname>signserver</groupname>
            <username>signserver</username>
        </addGroupToUser>
        <actionGroup>
            <actionList>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>masternode</variable>
                <key>hostname.masternode</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>hostname.masternode</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>allnodes</variable>
                <key>hostname.allnodes</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>hostname.allnodes</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet> 
            </actionList>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>exists</condition>
                </fileTest>
            </ruleList>
         </actionGroup>         
    </preInstallationActionList>
    <postInstallationActionList>
        <actionGroup>
            <actionList>
                <dos2unix>
                    <files>*/*.sh</files>
                </dos2unix>
                <createDirectory>
                    <path>/etc/signserver</path>
                </createDirectory>
                <createSymLink>
                  <linkName>/usr/local/bin/signserver.sh</linkName>
                  <target>${installdir}/bin/signserver.sh</target>
                </createSymLink>    
                <addTextToFile>
                  <file>/etc/signserver/signserver.conf</file>
                  <text>#SignServer properties file.</text>
                  <ruleList>
                    <fileTest>                    
                      <path>/etc/signserver/signserver.conf</path>
                      <condition>not_exists</condition>
                    </fileTest>
                  </ruleList>
                </addTextToFile>
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>hostname.masternode</key>
                  <value>${masternode}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>hostname.allnodes</key>
                  <value>${allnodes}</value>
                </propertiesFileSet>  
                <deleteFile>
                  <path>/etc/signserver/signservermgmt.env</path>
                </deleteFile>
                <addTextToFile>
                  <file>/etc/signserver/signservermgmt.env</file>
                  <text>export SIGNSRV_HOME=${installdir}</text>
                </addTextToFile>
            </actionList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </actionGroup>
        
    </postInstallationActionList>
    <postUninstallationActionList>
        <actionGroup>
          <actionList>
            <showQuestion>
            <text>

Do you want to remove the user 'signserver'?</text>
             <variable>remove_user</variable>
            </showQuestion>
            <actionGroup>
             <actionList>
                <deleteUser>
                  <abortOnError>0</abortOnError>
                  <showMessageOnError>0</showMessageOnError>
                  <username>signserver</username>            
                </deleteUser>
                <deleteGroup>
                  <abortOnError>0</abortOnError>
                  <groupname>signserver</groupname>
                  <showMessageOnError>0</showMessageOnError>
                </deleteGroup>
              </actionList>
              <ruleList>
                 <compareText>
                    <text>${remove_user}</text>
                    <logic>equals</logic>
                    <value>yes</value>
                 </compareText>
              </ruleList>
            </actionGroup>
            <showQuestion>
            <text>

Do you want to remove the configuration files in '/etc/signserver' ?</text>
             <variable>remove_config</variable>
             <default>no</default>
            </showQuestion>
            <actionGroup>
             <actionList>
               <deleteFile>
                 <path>/etc/signserver/signserver.conf</path>
               </deleteFile>
               <deleteFile>
                 <path>/etc/signserver/signservermgmt.env</path>
               </deleteFile>
              </actionList>
              <ruleList>
                 <compareText>
                    <text>${remove_config}</text>
                    <logic>equals</logic>
                    <value>yes</value>
                 </compareText>
              </ruleList>
            </actionGroup>
            <deleteFile>
              <path>/usr/local/bin/signserver.sh</path>
            </deleteFile>
            <createDirectory>
                <path>/usr/local/bin</path>
                <ruleList>
                  <fileTest>                    
                    <path>/usr/local/bin</path>
                    <condition>not_exists</condition>
                </fileTest>
                </ruleList>
            </createDirectory>
         </actionList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
            </ruleList>
      </actionGroup>
    </postUninstallationActionList>
    <defaultUnixGroup>signserver</defaultUnixGroup>
    <defaultUnixOwner>signserver</defaultUnixOwner>
    <enableRollback>1</enableRollback>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
                    
    <componentList>
        <component>
            <name>default</name>
            <description>Default Component</description>
            <canBeEdited>1</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfiles</name>
                    <platforms>all</platforms>
                    <shortcutList>
                        <shortcut>
                            <comment>Uninstall</comment>
                            <exec>${installdir}/${uninstallerName}</exec>
                            <icon></icon>
                            <name>Uninstall ${product_fullname}</name>
                            <path>${installdir}</path>
                            <platforms>all</platforms>
                            <runInTerminal>0</runInTerminal>
                            <windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
                            <windowsExecArgs></windowsExecArgs>
                            <windowsIcon></windowsIcon>
                            <windowsPath>${installdir}</windowsPath>
                        </shortcut>
                    </shortcutList>
                </folder>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux</name>
                    <platforms>linux</platforms>
                    <actionList>
                      <changePermissions>
                      <files>*/*.sh</files>
                      <permissions>744</permissions>
                      </changePermissions>
                    </actionList>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-mgmt/bin</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-mgmt/lib</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-mgmt/modules</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-mgmt/sample-configs</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
        </component>
    </componentList>
    <parameterList>
        <stringParameter>
          <name>masternode</name>
          <default>localhost</default>
          <description>Master Node</description>
          <explanation>Enter the hostname of your SignServer master node, this is the node that will primarily be used by the CLI interface.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>masternode</cliOptionName>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>not_exists</condition>
                </fileTest>
                <fileContentTest>
                  <path>/etc/signserver/signserver.conf</path>
                  <logic>does_not_contain</logic>
                  <text>hostname.masternode</text>
                </fileContentTest>
            </ruleList>
        </stringParameter>
        <stringParameter>
          <name>allnodes</name>
          <default>localhost</default>
          <description>All Nodes, separated by ';'</description>
          <explanation>Enter the hostnames of all the nodes in the SignServer Cluster.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>allnodes</cliOptionName>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>     
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>not_exists</condition>
                </fileTest>           
                <fileContentTest>
                  <path>/etc/signserver/signserver.conf</path>
                  <logic>does_not_contain</logic>
                  <text>hostname.allnodes</text>
                </fileContentTest>
            </ruleList>
        </stringParameter>
        <directoryParameter>
            <name>installdir</name>
            <description>Installer.Parameter.installdir.description</description>
            <explanation>Installer.Parameter.installdir.explanation</explanation>
            <value>${platform_install_prefix}/${product_shortname}-${product_version}</value>
            <default>${platform_install_prefix}/${product_shortname}-${product_version}</default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>prefix</cliOptionName>
            <mustBeWritable>yes</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
        </directoryParameter>
    </parameterList>

</project>

