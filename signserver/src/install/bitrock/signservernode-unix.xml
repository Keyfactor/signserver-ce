<project>
    <shortName>signservernode</shortName>
    <fullName>SignServer Node</fullName>
    <version>3.1</version>
    <readmeFile>../common/README.txt</readmeFile>
    <licenseFile>../../../doc/lgpl-2.1.txt</licenseFile>
    <!--<registerWithPackageDatabase>1</registerWithPackageDatabase> -->
    <vendor>PrimeKey Solutions AB</vendor>
    <summary>Server package for a node in a SignServer Cluster</summary>
    <release>3.1</release>
    <description>Server package for a node in a SignServer Cluster</description>
    <rebootRequired>0</rebootRequired>    
    <startMenuGroupName></startMenuGroupName>
    <preInstallationActionList>
        <setInstallerVariable>
                <name>installdir</name>
                <value>/opt/signserver-${product_version}</value>
                <ruleList>
                  <platformTest>                    
                    <type>linux</type>
                  </platformTest>                
                </ruleList>
        </setInstallerVariable>
        <setInstallerVariable>
                <name>uninstallerName</name>
                <value>uninstall-${product_shortname}</value>
                <ruleList>
                  <platformTest>                    
                    <type>linux</type>
                  </platformTest>                
                </ruleList>
        </setInstallerVariable>
        <autodetectJava>
            <promptUser>0</promptUser>
            <validVersionList>
                <validVersion>
                    <maxVersion></maxVersion>
                    <minVersion>1.5.0</minVersion>
                    <requireJDK>1</requireJDK>
                    <vendor>sun</vendor>
                </validVersion>
            </validVersionList>
        </autodetectJava>
        <addUser>
            <abortOnError>0</abortOnError>
            <showMessageOnError>0</showMessageOnError>
            <username>signserver</username>
        </addUser>
        <addGroup>
            <abortOnError>0</abortOnError>
            <groupname>signserver</groupname>
            <showMessageOnError>0</showMessageOnError>
        </addGroup>
        <addGroupToUser>
            <groupname>signserver</groupname>
            <username>signserver</username>
        </addGroupToUser>
        <actionGroup>
            <actionList>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>signservernodeid</variable>
                <key>SIGNSERVER_NODEID</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>SIGNSERVER_NODEID</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databasetype</variable>
                <key>database.type</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.type</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databasehosts</variable>
                <key>database.hosts</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.hosts</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databaseport</variable>
                <key>database.port</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.port</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databasename</variable>
                <key>database.name</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.name</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databaseuser</variable>
                <key>database.username</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.username</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>  
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>databasepwd</variable>
                <key>database.password</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>database.password</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>httpserverstorepath</variable>
                <key>httpserver.storepath</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>httpserver.storepath</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>httpserverpassword</variable>
                <key>httpserver.password</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>httpserver.password</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>httptruststorepath</variable>
                <key>httptrust.storepath</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>httptrust.storepath</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>httptrustpassword</variable>
                <key>httptrust.password</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>httptrust.password</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>httphostname</variable>
                <key>httpserver.hostname</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>httpserver.hostname</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
              <propertiesFileGet>
                <file>/etc/signserver/signserver.conf</file>
                <variable>sysloghostname</variable>
                <key>syslog.hostname</key>
                <ruleList>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>contains</logic>
                    <text>syslog.hostname</text>
                  </fileContentTest>
                </ruleList>
              </propertiesFileGet>
            </actionList>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>exists</condition>
                </fileTest>
            </ruleList>
         </actionGroup>        
    </preInstallationActionList>
    <postInstallationActionList>
        <actionGroup>
            <actionList>
                <dos2unix>
                    <files>*/*.sh</files>
                </dos2unix>
                <createDirectory>
                    <path>/etc/signserver</path>
                </createDirectory>
                <createSymLink>
                  <linkName>/etc/init.d/signserver</linkName>
                  <target>${installdir}/bin/signserver_jboss_init.sh</target>
                </createSymLink> 
                <createSymLink>
                   <linkName>/etc/rc0.d/K01signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc1.d/K01signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc2.d/K01signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc3.d/S99signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc4.d/S99signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc5.d/S99signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                   <linkName>/etc/rc6.d/K01signserver</linkName>
                   <target>/etc/init.d/signserver</target>                   
                </createSymLink>
                <createSymLink>
                  <linkName>/etc/signserver/database-conf.xml</linkName>
                  <target>${installdir}/deploy/signserver-ds.xml</target>
                  <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>does_not_equal</logic>
                       <value>mysqlndb</value>
                     </compareText>
                  </ruleList>
                </createSymLink>  
                <createSymLink>
                  <linkName>/etc/signserver/database-conf.xml</linkName>
                  <target>${installdir}/deploy/signserver-mysql-cluster-ds.xml</target>
                  <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>mysqlndb</value>
                     </compareText>
                  </ruleList>
                </createSymLink> 
                <createSymLink>
                  <linkName>${installdir}/jboss/server/default/deploy/signserver.ear</linkName>
                  <target>${installdir}/deploy/signserver.ear</target>
                </createSymLink> 
                <createSymLink>
                  <linkName>${installdir}/jboss/server/default/deploy/signserver-ds.xml</linkName>
                  <target>/etc/signserver/database-conf.xml</target>
                </createSymLink>
                <createSymLink>
                  <linkName>${installdir}/dbconf/mysqlndb</linkName>
                  <target>${installdir}/dbconf/mysql</target>
                </createSymLink> 
                <actionGroup>
                   <actionList>
                     <setInstallerVariable>
                       <name>databaseurl</name>
                       <value>jdbc:mysql://${databasehosts}:${databaseport}/${databasename}</value>
                    </setInstallerVariable> 
                    <setInstallerVariable>
                       <name>databasedriver</name>
                       <value>com.mysql.jdbc.Driver</value>
                    </setInstallerVariable>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>mysqlndb</value>
                     </compareText>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>mysql</value>
                     </compareText>              
                  </ruleList>
                </actionGroup>
                <actionGroup>
                   <actionList>
                     <setInstallerVariable>
                       <name>databaseurl</name>
                       <value>jdbc:hsqldb:@replace_varchars@jboss.server.data.dir}@replace_varchars@/}hypersonic@replace_varchars@/}SignServerLocalDB</value>
                    </setInstallerVariable> 
                    <setInstallerVariable>
                       <name>databasedriver</name>
                       <value>org.hsqldb.jdbcDriver</value>
                    </setInstallerVariable>
                    <setInstallerVariable>
                       <name>databaseuser</name>
                       <value>sa</value>
                    </setInstallerVariable>
                    <setInstallerVariable>
                       <name>databasepwd</name>
                       <value>@NOPASS@</value>
                    </setInstallerVariable>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>hsqldb</value>
                     </compareText>   
          
                  </ruleList>
                </actionGroup>
                <actionGroup>
                   <actionList>
                     <setInstallerVariable>
                       <name>databaseurl</name>
                       <value>jdbc:postqresql://${databasehosts}:${databaseport}/${databasename}</value>
                    </setInstallerVariable> 
                    <setInstallerVariable>
                       <name>databasedriver</name>
                       <value>org.postgresql.Driver</value>
                    </setInstallerVariable>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>postgres</value>
                     </compareText>             
                  </ruleList>
                </actionGroup>
                <actionGroup>
                   <actionList>
                     <setInstallerVariable>
                       <name>databaseurl</name>
                       <value>jdbc:jtds:sqlserver://${databasehosts}:${databaseport}/${databasename}</value>
                    </setInstallerVariable> 
                    <setInstallerVariable>
                       <name>databasedriver</name>
                       <value>net.sourceforge.jtds.jdbc.Driver</value>
                    </setInstallerVariable>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <compareText>
                       <text>${databasetype}</text>
                       <logic>equals</logic>
                       <value>mssql2000</value>
                     </compareText>             
                  </ruleList>
                </actionGroup>
                <substitute>
                  <files>${installdir}/deploy/*.xml</files>
                  <substitutionList>
                    <substitution>
                      <pattern>\$\{database.username\}</pattern>
                      <value>${databaseuser}</value>
                    </substitution>
                    <substitution>
                      <pattern>\$\{database.password\}</pattern>
                      <value>${databasepwd}</value>
                    </substitution>
                    <substitution>
                      <pattern>\$\{database.url\}</pattern>
                      <value>${databaseurl}</value>
                    </substitution>
                    <substitution>
                      <pattern>\$\{database.driver\}</pattern>
                      <value>${databasedriver}</value>
                    </substitution>
                    <substitution>
                      <pattern>\$\{datasource.jndi-name\}</pattern>
                      <value>SignServerDS</value>
                    </substitution>
                    <substitution>
                      <pattern>@NOPASS@</pattern>
                      <value></value>
                    </substitution>
                    <substitution>
                      <pattern>@replace_varchars@</pattern>
                      <value>${</value>
                    </substitution>
                  </substitutionList>
                </substitute>
                <runProgram>
                  <program>${java_executable}</program>
               <programArguments> -Xmx256m -jar setdbtype.jar ${installdir}/deploy/signserver.ear ${installdir}/dbconf/${databasetype}/entity-mappings.xml</programArguments>
               <workingDirectory>${installdir}/lib</workingDirectory>
           </runProgram>
           <actionGroup>
             <actionList>
                <setInstallerVariable>
                  <name>httpserverstorepath</name>
                  <value>/etc/signserver/tomcat.jks</value>
                </setInstallerVariable>
                <setInstallerVariable>
                  <name>httptruststorepath</name>
                  <value>/etc/signserver/truststore.jks</value>
                </setInstallerVariable>
                <generateRandomValue>
                  <variable>httpserverpassword</variable>
                  <length>8</length>
                </generateRandomValue>
                <generateRandomValue>
                  <variable>httptrustpassword</variable>
                  <length>8</length>
                </generateRandomValue>
                <generateRandomValue>
                  <variable>caserialnumber</variable>
                  <length>4</length>
                </generateRandomValue>
                <showInfo>
                  <text>

About to generate HTTPS dummy keystores. These should be used
during evaluation and test and not for production systems.
</text>
                </showInfo>
                <runProgram>
                  <program>${java_executable}</program>
                  <programArguments> -jar genservercert.jar "CN=SignServer Demo CA,SN=${caserialnumber}" "CN=${httphostname} O=SignServer Demo CA" /etc/signserver ${httpserverpassword} ${httptrustpassword} foo123</programArguments>
                  <workingDirectory>${installdir}/lib</workingDirectory>
                </runProgram>
                <changePermissions>
                  <files>/etc/signserver/*.jks</files>
                  <permissions>600</permissions>
                </changePermissions>
                <changeOwnerAndGroup>
                  <files>/etc/signserver/*.jks</files>
                  <owner>signserver</owner>
                  <group>signserver</group>
                </changeOwnerAndGroup>
              </actionList>
              <ruleEvaluationLogic>or</ruleEvaluationLogic>
              <ruleList>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>not_exists</condition>
                </fileTest>
                <fileContentTest>
                  <path>/etc/signserver/signserver.conf</path>
                  <logic>does_not_contain</logic>
                  <text>httpserver.storepath</text>
                </fileContentTest>
              </ruleList>
            </actionGroup>
                <createSymLink>
                  <linkName>${installdir}/jboss/server/default/deploy/jboss-web.deployer/server.xml</linkName>
                  <target>${installdir}/webconf/tomcat-server.xml</target>
                </createSymLink> 
                <createSymLink>
                  <linkName>/etc/signserver/webserver-conf.xml</linkName>
                  <target>${installdir}/webconf/tomcat-server.xml</target>
                </createSymLink>
                <substitute>
                  <files>${installdir}/webconf/tomcat-server.xml</files>
                  <substitutionList>
                    <substitution>
                      <pattern>@keystore.file@</pattern>
                      <value>${httpserverstorepath}</value>
                    </substitution>
                    <substitution>
                      <pattern>@httpsserver.password@</pattern>
                      <value>${httpserverpassword}</value>
                    </substitution>
                    <substitution>
                      <pattern>@truststore.file@</pattern>
                      <value>${httptruststorepath}</value>
                    </substitution>
                    <substitution>
                      <pattern>@java.trustpassword@</pattern>
                      <value>${httptrustpassword}</value>
                    </substitution>
                    <substitution>
                      <pattern>@web.contentencoding@</pattern>
                      <value>ISO-8859-1</value>
                    </substitution>
                  </substitutionList>
                </substitute>
                <substitute>
                  <files>${installdir}/bin/signserver_jboss_init.sh</files>
                  <substitutionList>
                    <substitution>
                      <pattern>@JBOSS_HOME@</pattern>
                      <value>${installdir}/jboss</value>
                    </substitution>
                  </substitutionList>
                </substitute>
                 
                <createDirectory>
                   <path>/var/log/signserver</path>
                </createDirectory>
                <changeOwnerAndGroup>
                  <files>/var/log/signserver</files>
                  <owner>signserver</owner>
                  <group>signserver</group>
                </changeOwnerAndGroup>

                <actionGroup>
                   <actionList>
                     <createSymLink>
                       <linkName>/etc/signserver/log-conf.xml</linkName>
                       <target>${installdir}/logconf/jboss-log4j-unix.xml</target>
                     </createSymLink> 
                     <createSymLink>
                       <linkName>${installdir}/jboss/server/default/conf/jboss-log4j.xml</linkName>
                       <target>${installdir}/logconf/jboss-log4j-unix.xml</target>
                     </createSymLink> 
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <compareText>
                      <text>${usesyslog}</text>
                      <logic>equals</logic>
                      <value>0</value>
                     </compareText> 
                     <fileTest>                    
                        <path>/etc/signserver/signserver.conf</path>
                        <condition>not_exists</condition>
                     </fileTest>
                     <fileContentTest>
                        <path>/etc/signserver/signserver.conf</path>
                        <logic>does_not_contain</logic>
                        <text>syslog.hostname</text>
                     </fileContentTest>                     
                   </ruleList>
                </actionGroup>
                <actionGroup>
                   <actionList>
                     <createSymLink>
                       <linkName>/etc/signserver/log-conf.xml</linkName>
                       <target>${installdir}/logconf/jboss-log4j-unix-syslog.xml</target>
                     </createSymLink> 
                     <createSymLink>
                       <linkName>${installdir}/jboss/server/default/conf/jboss-log4j.xml</linkName>
                       <target>${installdir}/logconf/jboss-log4j-unix-syslog.xml</target>
                     </createSymLink>
                     <substitute>
                       <files>${installdir}/logconf/jboss-log4j-unix-syslog.xml</files>
                       <substitutionList>
                         <substitution>
                           <pattern>@SYSLOG_HOST@</pattern>
                           <value>${sysloghostname}</value>
                         </substitution>
                       </substitutionList>
                     </substitute>
                   </actionList>
                   <ruleEvaluationLogic>or</ruleEvaluationLogic>
                   <ruleList>
                     <ruleGroup>
                       <ruleEvaluationLogic>and</ruleEvaluationLogic>
                       <ruleList>
                          <fileTest>                    
                            <path>/etc/signserver/signserver.conf</path>
                            <condition>exists</condition>
                          </fileTest>
                          <fileContentTest>
                            <path>/etc/signserver/signserver.conf</path>
                            <logic>contains</logic>
                            <text>syslog.hostname</text>
                          </fileContentTest>
                        </ruleList>
                     </ruleGroup>
                     <compareText>
                      <text>${usesyslog}</text>
                      <logic>equals</logic>
                      <value>1</value>
                     </compareText>
                   </ruleList>
                </actionGroup>
                <addTextToFile>
                  <file>/etc/signserver/signserver.conf</file>
                  <text>#SignServer properties file.</text>
                  <ruleList>
                    <fileTest>                    
                      <path>/etc/signserver/signserver.conf</path>
                      <condition>not_exists</condition>
                    </fileTest>
                  </ruleList>
                </addTextToFile>
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>SIGNSERVER_NODEID</key>
                  <value>${signservernodeid}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.type</key>
                  <value>${databasetype}</value>
                </propertiesFileSet>
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.hosts</key>
                  <value>${databasehosts}</value>
                </propertiesFileSet> 
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.port</key>
                  <value>${databaseport}</value>
                </propertiesFileSet> 
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.name</key>
                  <value>${databasename}</value>
                </propertiesFileSet> 
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.username</key>
                  <value>${databaseuser}</value>
                </propertiesFileSet> 
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>database.password</key>
                  <value>${databasepwd}</value>
                </propertiesFileSet> 
                <propertiesFileSet>
                  <file>/etc/signserver/signserver.conf</file>
                  <key>httpserver.hostname</key>
                  <value>${httphostname}</value>
                </propertiesFileSet> 
                <actionGroup>
                  <actionList>
                    <propertiesFileSet>
                      <file>/etc/signserver/signserver.conf</file>
                      <key>syslog.hostname</key>
                      <value>${sysloghostname}</value>
                    </propertiesFileSet> 
                  </actionList>
                  <ruleEvaluationLogic>or</ruleEvaluationLogic>
                  <ruleList>
                     <ruleGroup>
                       <ruleEvaluationLogic>and</ruleEvaluationLogic>
                       <ruleList>
                          <fileTest>                    
                            <path>/etc/signserver/signserver.conf</path>
                            <condition>exists</condition>
                          </fileTest>
                          <fileContentTest>
                            <path>/etc/signserver/signserver.conf</path>
                            <logic>contains</logic>
                            <text>syslog.hostname</text>
                          </fileContentTest>
                        </ruleList>
                     </ruleGroup>
                     <compareText>
                      <text>${usesyslog}</text>
                      <logic>equals</logic>
                      <value>1</value>
                     </compareText>
                   </ruleList>
                </actionGroup>
                <deleteFile>
                  <path>/etc/signserver/signservermgmt.env</path>
                </deleteFile>
                <addTextToFile>
                  <file>/etc/signserver/signservermgmt.env</file>
                  <text>export SIGNSRV_HOME=${installdir}</text>
                </addTextToFile>
                <showInfo>
                  <text>

About to start the JBoss Application Server. This will be done in the background and will be ready to process requests in about 1 minute.
</text>
                </showInfo>
                <runProgram>
                  <program>/etc/init.d/signserver</program>
                  <programArguments> start</programArguments>
                  <workingDirectory>/</workingDirectory>
                </runProgram>
            </actionList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
            </ruleList>
        </actionGroup>
        
    </postInstallationActionList>
    <preUninstallationActionList>
       <actionGroup>
         <actionList>
           <showInfo>
             <text>

Before uninstalling the SignServer must JBoss be stopped. This might take a few seconds.

</text>
          
           </showInfo>
           <runProgram>
              <program>/etc/init.d/signserver</program>
              <programArguments> stop</programArguments>
              <workingDirectory>/</workingDirectory>
           </runProgram>
           <waitForPort>
             <state>free</state>
             <port>1099</port>
             <timeout>240000</timeout>
           </waitForPort>
         </actionList>
         <ruleList>
           <portTest>
              <port>1099</port>
              <condition>cannot_bind</condition>
           </portTest>
         </ruleList>
      </actionGroup>
    </preUninstallationActionList>
    <postUninstallationActionList>
        <actionGroup>
          <actionList>
            <showQuestion>
            <text>

Do you want to remove the user 'signserver'?</text>
             <variable>remove_user</variable>
            </showQuestion>
            <actionGroup>
             <actionList>
                <deleteUser>
                  <abortOnError>0</abortOnError>
                  <showMessageOnError>0</showMessageOnError>
                  <username>signserver</username>            
                </deleteUser>
                <deleteGroup>
                  <abortOnError>0</abortOnError>
                  <groupname>signserver</groupname>
                  <showMessageOnError>0</showMessageOnError>
                </deleteGroup>
              </actionList>
              <ruleList>
                 <compareText>
                    <text>${remove_user}</text>
                    <logic>equals</logic>
                    <value>yes</value>
                 </compareText>
              </ruleList>
            </actionGroup>
            <showQuestion>
            <text>

Do you want to remove the log files in '/var/log/signserver' ?</text>
             <variable>remove_log</variable>
             <default>yes</default>
            </showQuestion>
            <actionGroup>
             <actionList>
               <deleteFile>
                 <path>/var/log/signserver</path>
               </deleteFile>
              </actionList>
              <ruleList>
                 <compareText>
                    <text>${remove_log}</text>
                    <logic>equals</logic>
                    <value>yes</value>
                 </compareText>
              </ruleList>
            </actionGroup> 
            <showQuestion>
            <text>

Do you want to remove the configuration files in '/etc/signserver' ?</text>
             <variable>remove_config</variable>
             <default>no</default>
            </showQuestion>
            <actionGroup>
             <actionList>
               <deleteFile>
                 <path>/etc/signserver</path>
               </deleteFile>
              </actionList>
              <ruleList>
                 <compareText>
                    <text>${remove_config}</text>
                    <logic>equals</logic>
                    <value>yes</value>
                 </compareText>
              </ruleList>
            </actionGroup> 
            <deleteFile>
              <path>/etc/rc0.d/K01signserver</path>
            </deleteFile> 
            <deleteFile>
              <path>/etc/rc1.d/K01signserver</path>
            </deleteFile> 
            <deleteFile>
              <path>/etc/rc2.d/K01signserver</path>
            </deleteFile>      
            <deleteFile>
              <path>/etc/rc3.d/S99signserver</path>
            </deleteFile> 
            <deleteFile>
              <path>/etc/rc4.d/S99signserver</path>
            </deleteFile>      
            <deleteFile>
              <path>/etc/rc5.d/S99signserver</path>
            </deleteFile>  
            <deleteFile>
              <path>/etc/rc6.d/K01signserver</path>
            </deleteFile>       
            <deleteFile>
              <path>/etc/init.d/signserver</path>
            </deleteFile>
            <deleteFile>
              <path>${installdir}/jboss</path>
            </deleteFile>
            <actionGroup>
             <actionList>
                <deleteFile>
                  <path>${installdir}</path>                   
                </deleteFile>
             </actionList>
             <ruleList>
               <fileTest>
                 <path>${installdir}</path>
                 <condition>is_empty</condition>
               </fileTest> 
             </ruleList>
           </actionGroup>
         </actionList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <platformTest>                    
                    <type>linux</type>
                </platformTest>
            </ruleList>
      </actionGroup>
    </postUninstallationActionList>
    <defaultUnixGroup>signserver</defaultUnixGroup>
    <defaultUnixOwner>signserver</defaultUnixOwner>
    <enableRollback>1</enableRollback>
    <requireInstallationByRootUser>1</requireInstallationByRootUser>
    <saveRelativePaths>1</saveRelativePaths>
                    
    <componentList>
        <component>
            <name>default</name>
            <description>Default Component</description>
            <canBeEdited>1</canBeEdited>
            <selected>1</selected>
            <show>1</show>
            <folderList>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfiles</name>
                    <platforms>all</platforms>
                    <shortcutList>
                        <shortcut>
                            <comment>Uninstall</comment>
                            <exec>${installdir}/${uninstallerName}</exec>
                            <icon></icon>
                            <name>Uninstall ${product_fullname}</name>
                            <path>${installdir}</path>
                            <platforms>all</platforms>
                            <runInTerminal>0</runInTerminal>
                            <windowsExec>${installdir}/${uninstallerName}.exe</windowsExec>
                            <windowsExecArgs></windowsExecArgs>
                            <windowsIcon></windowsIcon>
                            <windowsPath>${installdir}</windowsPath>
                        </shortcut>
                    </shortcutList>
                </folder>
                <folder>
                    <description>Program Files</description>
                    <destination>${installdir}</destination>
                    <name>programfileslinux</name>
                    <platforms>linux</platforms>
                    <actionList>
                      <changePermissions>
                      <files>*/*.sh</files>
                      <permissions>744</permissions>
                      </changePermissions>
                    </actionList>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/bin</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/lib</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/deploy</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/webconf</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/dbconf</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>../../../dist-pkg/usr/share/signserver-server/logconf</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
               <folder>
                    <description>Program Files</description>
                    <destination>${installdir}/jboss</destination>
                    <name>jbosslinux</name>
                    <platforms>linux</platforms>
                    <actionList>
                      <changePermissions>
                      <files>*/*.sh</files>
                      <permissions>744</permissions>
                      </changePermissions>
                    </actionList>
                    <distributionFileList>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/bin</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/server</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/lib</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/client</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/copyright.txt</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/lgpl.html</origin>
                        </distributionDirectory>
                        <distributionDirectory>
                            <origin>${env(JBOSS_PREP)}/readme.html</origin>
                        </distributionDirectory>
                    </distributionFileList>
                </folder>
            </folderList>
        </component>
    </componentList>
    <parameterList>
        <stringParameter>
          <name>signservernodeid</name>
          <default>node1</default>
          <description>Node Id</description>
          <explanation>Enter an id of the node, this id must be a unique string for that node in a cluster (for example 'node1').</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>signservernodeid</cliOptionName>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
              <fileTest>                    
                <path>/etc/signserver/signserver.conf</path>
                <condition>not_exists</condition>
              </fileTest>
              <fileContentTest>
                <path>/etc/signserver/signserver.conf</path>
                <logic>does_not_contain</logic>
                <text>SIGNSERVER_NODEID</text>
              </fileContentTest>
            </ruleList>
        </stringParameter>
      <choiceParameter>
          <ask>1</ask>
          <default>hsqldb</default>
          <description>Which type of database is going to be used?</description>
          <explanation></explanation>
          <title>Database Selection</title>
          <name>databasetype</name>
           <optionList>
              <option>
                <value>hsqldb</value>
                <text>Hypersonic</text>
              </option>
              <option>
                <value>mysql</value>
                <text>Mysql</text>
              </option>
              <option>
                <value>mysqlndb</value>
                <text>Mysql NDB Cluster</text>
              </option>
              <option>
                <value>postgres</value>
                <text>Postgres</text>
              </option>
              <option>
                <value>mssql2000</value>
                <text>Microsoft SQL Server</text>
              </option>
            </optionList>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>not_exists</condition>
                </fileTest>
                <fileContentTest>
                  <path>/etc/signserver/signserver.conf</path>
                  <logic>does_not_contain</logic>
                  <text>database.type</text>
                </fileContentTest>
            </ruleList>
        </choiceParameter>
        <stringParameter>
          <name>databasehosts</name>
          <default>localhost</default>
          <description>Database hosts</description>
          <explanation>Enter the hostname of the backend database, if multiple hostnames use ',' as separator</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>databasehosts</cliOptionName>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
              <ruleGroup>
                <ruleEvaluationLogic>or</ruleEvaluationLogic>
                <ruleList>
                  <fileTest>                    
                    <path>/etc/signserver/signserver.conf</path>
                    <condition>not_exists</condition>
                  </fileTest>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>does_not_contain</logic>
                    <text>database.hosts</text>
                  </fileContentTest>
                </ruleList>
              </ruleGroup>
              <compareText>
                 <text>${databasetype}</text>
                 <logic>does_not_equal</logic>
                 <value>hsqldb</value>
              </compareText>
            </ruleList>
        </stringParameter>
        <stringParameter>
          <name>databaseport</name>
          <default></default>
          <description>Database Port</description>
          <explanation>Enter the port of the backend database, (Standard is 3306 for Mysql, Mysql NDB Cluster, 5432 for Postgres and 1433 for MS SQL Server.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>databaseport</cliOptionName>
            <default>3306</default>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
              <ruleGroup>
                <ruleEvaluationLogic>or</ruleEvaluationLogic>
                <ruleList>
                  <fileTest>                    
                    <path>/etc/signserver/signserver.conf</path>
                    <condition>not_exists</condition>
                  </fileTest>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>does_not_contain</logic>
                    <text>database.port</text>
                  </fileContentTest>
                </ruleList>
              </ruleGroup>
              <compareText>
                 <text>${databasetype}</text>
                 <logic>does_not_equal</logic>
                 <value>hsqldb</value>
              </compareText>
            </ruleList>
        </stringParameter>
        <stringParameter>
          <name>databasename</name>
          <default>signserver</default>
          <description>Database Name</description>
          <explanation>Enter the name of the backend database.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>databasename</cliOptionName>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
              <ruleGroup>
                <ruleEvaluationLogic>or</ruleEvaluationLogic>
                <ruleList>
                  <fileTest>                    
                    <path>/etc/signserver/signserver.conf</path>
                    <condition>not_exists</condition>
                  </fileTest>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>does_not_contain</logic>
                    <text>database.name</text>
                  </fileContentTest>
                </ruleList>
              </ruleGroup>
              <compareText>
                 <text>${databasetype}</text>
                 <logic>does_not_equal</logic>
                 <value>hsqldb</value>
              </compareText>
            </ruleList>
        </stringParameter>
        <stringParameter>
          <name>databaseuser</name>
          <default>signserver</default>
          <description>Database Username</description>
          <explanation>Enter the username used when connecting to the database.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>databaseuser</cliOptionName>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
              <ruleGroup>
                <ruleEvaluationLogic>or</ruleEvaluationLogic>
                <ruleList>
                  <fileTest>                    
                    <path>/etc/signserver/signserver.conf</path>
                    <condition>not_exists</condition>
                  </fileTest>
                  <fileContentTest>
                    <path>/etc/signserver/signserver.conf</path>
                    <logic>does_not_contain</logic>
                    <text>database.username</text>
                  </fileContentTest>
                </ruleList>
              </ruleGroup>
              <compareText>
                 <text>${databasetype}</text>
                 <logic>does_not_equal</logic>
                 <value>hsqldb</value>
              </compareText>
            </ruleList>
        </stringParameter>
        <passwordParameter>
          <ask>yes</ask>
          <name>databasepwd</name>
          <description>Database password</description>
          <descriptionRetype>Retype password</descriptionRetype>
          <explanation>Please provide a password for the database user</explanation>
          <cliOptionName>databasepwd</cliOptionName>
          <default>signserver</default>
          <value/>
          <allowEmptyValue>0</allowEmptyValue>
          <ruleEvaluationLogic>and</ruleEvaluationLogic>
          <ruleList>
            <ruleGroup>
              <ruleEvaluationLogic>or</ruleEvaluationLogic>
              <ruleList>
                <fileTest>                    
                  <path>/etc/signserver/signserver.conf</path>
                  <condition>not_exists</condition>
                </fileTest>
                <fileContentTest>
                  <path>/etc/signserver/signserver.conf</path>
                  <logic>does_not_contain</logic>
                  <text>database.password</text>
                </fileContentTest>
              </ruleList>
            </ruleGroup>
            <compareText>
              <text>${databasetype}</text>
              <logic>does_not_equal</logic>
              <value>hsqldb</value>
            </compareText>
          </ruleList>
      </passwordParameter>
        <stringParameter>
          <name>httphostname</name>
          <default>${machine_fqdn}</default>
          <description>Hostname</description>
          <explanation>Enter the DNS hostname of the cluster, (used in the SSL server certificate).</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>httphostname</cliOptionName>
            <ruleEvaluationLogic>or</ruleEvaluationLogic>
            <ruleList>
               <fileTest>                    
                 <path>/etc/signserver/signserver.conf</path>
                 <condition>not_exists</condition>
               </fileTest>
               <fileContentTest>
                 <path>/etc/signserver/signserver.conf</path>
                 <logic>does_not_contain</logic>
                 <text>httpserver.hostname</text>
               </fileContentTest>
            </ruleList>
        </stringParameter>
        <booleanParameter>
          <name>usesyslog</name>
          <ask>yes</ask>
          <default>0</default>
          <title>Use Syslog</title>
          <explanation>Do you want to send events to Syslog?</explanation>
          <cliOptionName>usesyslog</cliOptionName>
          <ruleEvaluationLogic>or</ruleEvaluationLogic>
          <ruleList>
               <fileTest>                    
                 <path>/etc/signserver/signserver.conf</path>
                 <condition>not_exists</condition>
               </fileTest>
               <fileContentTest>
                 <path>/etc/signserver/signserver.conf</path>
                 <logic>does_not_contain</logic>
                 <text>syslog.hostname</text>
               </fileContentTest>
            </ruleList>
        </booleanParameter>
        <stringParameter>
          <name>sysloghostname</name>
          <default>localhost</default>
          <description>Syslog Hostname</description>
          <explanation>Enter the hostname of the Syslog server.</explanation>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>sysloghostname</cliOptionName>
            <ruleEvaluationLogic>and</ruleEvaluationLogic>
            <ruleList>
              <ruleGroup>
                <ruleEvaluationLogic>or</ruleEvaluationLogic>
                <ruleList>
                   <fileTest>                    
                     <path>/etc/signserver/signserver.conf</path>
                     <condition>not_exists</condition>
                   </fileTest>
                   <fileContentTest>
                      <path>/etc/signserver/signserver.conf</path>
                      <logic>does_not_contain</logic>
                      <text>syslog.hostname</text>
                   </fileContentTest>
                </ruleList>
              </ruleGroup>
               <compareText>
                    <text>${usesyslog}</text>
                    <logic>equals</logic>
                    <value>1</value>
               </compareText>
            </ruleList>
        </stringParameter>
        <directoryParameter>
            <name>installdir</name>
            <description>Installer.Parameter.installdir.description</description>
            <explanation>Installer.Parameter.installdir.explanation</explanation>
            <value>${platform_install_prefix}/${product_shortname}-${product_version}</value>
            <default>${platform_install_prefix}/${product_shortname}-${product_version}</default>
            <allowEmptyValue>0</allowEmptyValue>
            <ask>yes</ask>
            <cliOptionName>prefix</cliOptionName>
            <mustBeWritable>yes</mustBeWritable>
            <mustExist>0</mustExist>
            <width>40</width>
        </directoryParameter>
    </parameterList>

</project>

